<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добавить бронирование - Гостиница</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header>
        <div class="header-container">
            <h1>Гостиница "Престиж"</h1>
            <nav>
                <a href="/">Главная</a>
                <a href="/clients">Клиенты</a>
                <a href="/bookings">Бронирования</a>
                <a href="/stays">Проживания</a>
                <% if (user) { %>
                    <a href="/profile">Профиль</a>
                    <a href="/auth/logout">Выйти (<%= user.login %>)</a>
                <% } else { %>
                    <a href="/auth/login">Войти</a>
                    <a href="/auth/register">Регистрация</a>
                <% } %>
            </nav>
        </div>
    </header>

    <main>
        <div class="header-actions">
            <h2>Добавление нового бронирования</h2>
            <a href="/bookings" class="btn btn-secondary">← Назад к бронированиям</a>
        </div>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error"><%= error %></div>
        <% } %>

        <form action="/bookings/add" method="POST" class="form">
            <div class="form-group">
                <label for="client_passport">Клиент:*</label>
                <select id="client_passport" name="client_passport" required>
                    <option value="">Выберите клиента</option>
                    <% clients.forEach(client => { %>
                        <option value="<%= client.passport_data %>">
                            <%= client.last_name %> <%= client.first_name %> (<%= client.passport_data %>)
                        </option>
                    <% }); %>
                </select>
            </div>

            <div class="form-group">
                <label for="room_id">Номер:*</label>
                <select id="room_id" name="room_id" required>
                    <option value="">Выберите номер</option>
                    <% rooms.forEach(room => { %>
                        <option value="<%= room.id %>" 
                                data-price="<%= room.price_per_night %>"
                                data-capacity="<%= room.capacity %>">
                            №<%= room.room_number %> - <%= room.room_type %> 
                            (<%= room.price_per_night %> ₽/ночь, до <%= room.capacity %> чел.)
                        </option>
                    <% }); %>
                </select>
            </div>

            <div class="form-group">
                <label for="check_in_date">Дата заезда:*</label>
                <input type="date" id="check_in_date" name="check_in_date" required 
                       min="<%= new Date().toISOString().split('T')[0] %>" autofocus>
            </div>

            <div class="form-group">
                <label for="check_out_date">Дата выезда:*</label>
                <input type="date" id="check_out_date" name="check_out_date" required 
                       min="<%= new Date().toISOString().split('T')[0] %>">
            </div>

            <div class="form-group">
                <label for="guests_count">Количество гостей:*</label>
                <input type="number" id="guests_count" name="guests_count" value="1" 
                       required min="1" max="10">
            </div>

            <div class="form-group">
                <label for="special_requests">Особые пожелания:</label>
                <textarea id="special_requests" name="special_requests" 
                          placeholder="Дополнительные пожелания клиента" rows="3"></textarea>
            </div>

            <div class="info-box" style="margin: 1.5rem 0;">
                <h3>Информация о бронировании</h3>
                <p><strong>Количество ночей:</strong> <span id="nights-count">—</span></p>
                <p><strong>Предварительная стоимость:</strong> <span id="total-price">—</span></p>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Создать бронирование</button>
                <a href="/bookings" class="btn btn-secondary">Отмена</a>
            </div>
        </form>
    </main>

    <script>
        function calculateBookingInfo() {
            const checkIn = document.getElementById('check_in_date').value;
            const checkOut = document.getElementById('check_out_date').value;
            const roomSelect = document.getElementById('room_id');
            const selectedRoom = roomSelect.options[roomSelect.selectedIndex];
            const pricePerNight = selectedRoom ? parseFloat(selectedRoom.getAttribute('data-price')) : 0;
            const capacity = selectedRoom ? parseInt(selectedRoom.getAttribute('data-capacity')) : 1;
            
            // Обновляем максимальное количество гостей
            const guestsInput = document.getElementById('guests_count');
            guestsInput.max = capacity;
            
            if (checkIn && checkOut && pricePerNight > 0) {
                const nights = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
                const totalPrice = nights * pricePerNight;
                
                document.getElementById('nights-count').textContent = nights;
                document.getElementById('total-price').textContent = totalPrice.toLocaleString('ru-RU') + ' ₽';
            } else {
                document.getElementById('nights-count').textContent = '—';
                document.getElementById('total-price').textContent = '—';
            }
        }

        // Слушатели событий для пересчета
        document.getElementById('check_in_date').addEventListener('change', calculateBookingInfo);
        document.getElementById('check_out_date').addEventListener('change', calculateBookingInfo);
        document.getElementById('room_id').addEventListener('change', calculateBookingInfo);
        document.getElementById('guests_count').addEventListener('input', calculateBookingInfo);

        // Автоматическая установка минимальной даты выезда
        document.getElementById('check_in_date').addEventListener('change', function() {
            const checkOut = document.getElementById('check_out_date');
            checkOut.min = this.value;
            if (checkOut.value && checkOut.value < this.value) {
                checkOut.value = '';
            }
        });
    </script>
</body>
</html>